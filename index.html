<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione spese by Ezio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mode-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .help-button {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .help-button:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .help-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .help-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        .help-section {
            border-bottom: 1px solid #e5e7eb;
            padding: 20px;
        }
        .help-section:last-child {
            border-bottom: none;
        }
        .help-tab {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin: 5px;
        }
        .help-tab:hover {
            background: #f3f4f6;
        }
        .help-tab.active {
            background: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="p-4">
    <!-- Pulsante Aiuto Fisso -->
    <div class="help-button" onclick="showHelp()" title="Aiuto e istruzioni">
        <i class="fas fa-question text-blue-600 text-xl"></i>
    </div>

    <!-- Modal Aiuto -->
    <div id="helpModal" class="help-modal hidden">
        <div class="help-content">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-question-circle text-blue-600 mr-3"></i>
                    Aiuto - Gestione Spese by Ezio
                </h2>
                <button onclick="hideHelp()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Tabs -->
            <div class="flex flex-wrap p-4 border-b border-gray-200">
                <div class="help-tab active" onclick="showHelpSection('generale')">
                    <i class="fas fa-info-circle mr-2"></i>Generale
                </div>
                <div class="help-tab" onclick="showHelpSection('locale')">
                    <i class="fas fa-home mr-2"></i>Modalità Locale
                </div>
                <div class="help-tab" onclick="showHelpSection('condivisa')">
                    <i class="fas fa-cloud mr-2"></i>Modalità Condivisa
                </div>
                <div class="help-tab" onclick="showHelpSection('faq')">
                    <i class="fas fa-question mr-2"></i>FAQ
                </div>
            </div>

            <!-- Contenuto Sezioni -->
            <div id="helpContent">
                <!-- Sezione Generale -->
                <div id="help-generale" class="help-section">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        Cos'è Gestione Spese by Ezio?
                    </h3>
                    <div class="space-y-4 text-gray-700">
                        <p>Un'app semplice e potente per gestire le spese condivise tra amici, famiglia o colleghi.</p>
                        
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                            <h4 class="font-bold text-blue-800 mb-2">Due modalità disponibili:</h4>
                            <ul class="space-y-2">
                                <li><strong>Modalità Locale:</strong> Gestisci le spese sul tuo dispositivo, funziona offline</li>
                                <li><strong>Modalità Condivisa:</strong> Sincronizzazione in tempo reale con altri utenti</li>
                            </ul>
                        </div>

                        <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                            <h4 class="font-bold text-green-800 mb-2">Funzionalità principali:</h4>
                            <ul class="space-y-1">
                                <li>• Gestione partecipanti</li>
                                <li>• Inserimento spese dettagliate</li>
                                <li>• Calcolo automatico dei bilanci</li>
                                <li>• Suggerimenti di rimborso</li>
                                <li>• Esportazione dati</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Sezione Modalità Locale -->
                <div id="help-locale" class="help-section hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-home text-blue-600 mr-2"></i>
                        Come usare la Modalità Locale
                    </h3>
                    <div class="space-y-4 text-gray-700">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 mb-2">1. Aggiungere Partecipanti</h4>
                            <p>Inserisci il nome nel campo "Nome partecipante" e clicca "Aggiungi". Puoi rimuovere partecipanti cliccando l'icona cestino.</p>
                        </div>

                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-800 mb-2">2. Inserire una Spesa</h4>
                            <ul class="space-y-1">
                                <li>• <strong>Descrizione:</strong> Cosa hai comprato (es. "Cena al ristorante")</li>
                                <li>• <strong>Importo:</strong> Quanto hai speso in euro</li>
                                <li>• <strong>Data:</strong> Quando è avvenuta la spesa</li>
                                <li>• <strong>Pagatore:</strong> Chi ha pagato</li>
                                <li>• <strong>Partecipanti:</strong> Seleziona chi deve dividere la spesa</li>
                            </ul>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="font-bold text-orange-800 mb-2">3. Leggere i Bilanci</h4>
                            <p>La sezione "Bilanci" mostra:</p>
                            <ul class="space-y-1">
                                <li>• <span class="text-green-600">Verde:</span> Quanto devi ricevere</li>
                                <li>• <span class="text-red-600">Rosso:</span> Quanto devi dare</li>
                                <li>• <span class="text-gray-600">Grigio:</span> Sei in pari</li>
                            </ul>
                        </div>

                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-800 mb-2">4. Funzioni Extra</h4>
                            <ul class="space-y-1">
                                <li>• <strong>Esporta:</strong> Salva i dati in un file</li>
                                <li>• <strong>Reset:</strong> Cancella tutti i dati (attenzione!)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Sezione Modalità Condivisa -->
                <div id="help-condivisa" class="help-section hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-cloud text-purple-600 mr-2"></i>
                        Come usare la Modalità Condivisa
                    </h3>
                    <div class="space-y-4 text-gray-700">
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-bold text-green-800 mb-2">1. Creare un Nuovo Gruppo</h4>
                            <ul class="space-y-1">
                                <li>• Clicca "Crea Nuovo Gruppo"</li>
                                <li>• Inserisci nome e descrizione del gruppo</li>
                                <li>• Riceverai un codice tipo "SPESE-ABC123"</li>
                                <li>• Condividi questo codice con gli altri</li>
                            </ul>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 mb-2">2. Unirsi a un Gruppo</h4>
                            <ul class="space-y-1">
                                <li>• Clicca "Unisciti a Gruppo"</li>
                                <li>• Inserisci il codice ricevuto</li>
                                <li>• Inserisci il tuo nome</li>
                                <li>• Clicca "Unisciti al Gruppo"</li>
                            </ul>
                        </div>

                        <div class="bg-orange-50 p-4 rounded-lg">
                            <h4 class="font-bold text-orange-800 mb-2">3. Gestire il Gruppo</h4>
                            <p>Una volta nel gruppo puoi:</p>
                            <ul class="space-y-1">
                                <li>• Aggiungere nuovi partecipanti</li>
                                <li>• Inserire spese (come in modalità locale)</li>
                                <li>• Vedere le spese di tutti in tempo reale</li>
                                <li>• Calcolare i bilanci aggiornati</li>
                                <li>• Cliccare "Aggiorna" per sincronizzare</li>
                            </ul>
                        </div>

                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-bold text-purple-800 mb-2">4. Condividere il Codice</h4>
                            <p>Puoi condividere il codice gruppo tramite:</p>
                            <ul class="space-y-1">
                                <li>• WhatsApp, Telegram, SMS</li>
                                <li>• Email o social media</li>
                                <li>• Mostrando il codice di persona</li>
                            </ul>
                        </div>

                        <div class="bg-yellow-50 p-4 rounded-lg border-l-4 border-yellow-500">
                            <h4 class="font-bold text-yellow-800 mb-2">💡 Rientrare nel Gruppo</h4>
                            <p>Se hai già partecipato a un gruppo e vuoi rientrare:</p>
                            <ul class="space-y-1">
                                <li>• Usa lo stesso <strong>codice gruppo</strong></li>
                                <li>• Inserisci lo stesso <strong>nome</strong> usato prima</li>
                                <li>• Il sistema ti riconoscerà automaticamente</li>
                                <li>• Non verrai aggiunto come duplicato</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Sezione FAQ -->
                <div id="help-faq" class="help-section hidden">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-question text-orange-600 mr-2"></i>
                        Domande Frequenti (FAQ)
                    </h3>
                    <div class="space-y-4">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ Quale modalità scegliere?</h4>
                            <p class="text-gray-700">
                                <strong>Locale:</strong> Per uso personale o quando sei sempre tu a inserire le spese.<br>
                                <strong>Condivisa:</strong> Quando più persone devono inserire spese nello stesso gruppo.
                            </p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ I miei dati sono sicuri?</h4>
                            <p class="text-gray-700">
                                <strong>Modalità Locale:</strong> I dati restano solo sul tuo dispositivo.<br>
                                <strong>Modalità Condivisa:</strong> I dati sono salvati su server sicuro e accessibili solo con il codice gruppo.
                            </p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ Non riesco a rientrare nel mio gruppo!</h4>
                            <p class="text-gray-700">
                                Se hai creato un gruppo e non riesci a rientrare:<br>
                                1. Usa lo <strong>stesso nome</strong> con cui hai creato il gruppo<br>
                                2. Inserisci il <strong>codice gruppo</strong> corretto<br>
                                3. Il sistema ti riconoscerà automaticamente<br>
                                4. Se il problema persiste, prova a ricaricare la pagina
                            </p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ Cosa fare se non funziona la modalità condivisa?</h4>
                            <p class="text-gray-700">
                                1. Controlla la connessione internet<br>
                                2. Verifica che il codice gruppo sia corretto<br>
                                3. Prova a cliccare "Aggiorna"<br>
                                4. Ricarica la pagina se necessario
                            </p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ Posso usare l'app su mobile?</h4>
                            <p class="text-gray-700">
                                Sì! L'app è ottimizzata per smartphone e tablet. Funziona su qualsiasi browser moderno.
                            </p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ Come interpreto i bilanci?</h4>
                            <p class="text-gray-700">
                                • <span class="text-green-600 font-bold">Importo positivo (verde):</span> Devi ricevere soldi<br>
                                • <span class="text-red-600 font-bold">Importo negativo (rosso):</span> Devi dare soldi<br>
                                • <span class="text-gray-600 font-bold">Zero (grigio):</span> Sei in pari
                            </p>
                        </div>

                        <div class="border border-gray-200 rounded-lg p-4">
                            <h4 class="font-bold text-gray-800 mb-2">❓ Posso modificare o cancellare una spesa?</h4>
                            <p class="text-gray-700">
Sì! Ora puoi modificare o cancellare le spese utilizzando le icone di modifica (matita) e cancellazione (cestino) accanto a ciascuna spesa.
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-200 bg-gray-50 text-center">
                <p class="text-gray-600">
                    <i class="fas fa-heart text-red-500 mr-1"></i>
                    Creato da Ezio - Gestione Spese Semplice e Veloce
                </p>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-calculator text-white text-4xl mr-3"></i>
                <h1 class="text-4xl font-bold text-white">Gestione spese by Ezio</h1>
            </div>
            <p class="text-white 
                
            </p>
        </div>


        <div id="modeSelection" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="mode-card glass-card rounded-xl p-8 shadow-xl text-center" onclick="useLocalMode()">
                <i class="fas fa-home text-blue-600 text-5xl mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Modalità Locale</h2>
                <p class="text-gray-600 mb-4">Gestisci le spese sul tuo dispositivo</p>
                <ul class="text-sm text-gray-500 text-left space-y-1">
                    <li>• Funziona offline</li>
                    <li>• Dati privati e sicuri</li>
                    <li>• Nessuna configurazione richiesta</li>
                </ul>
            </div>
            
            <div class="mode-card glass-card rounded-xl p-8 shadow-xl text-center" onclick="useSharedMode()">
                <i class="fas fa-cloud text-purple-600 text-5xl mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Modalità Condivisa</h2>
                <p class="text-gray-600 mb-4">Sincronizzazione in tempo reale</p>
                <ul class="text-sm text-gray-500 text-left space-y-1">
                    <li>• Gruppi con codici di accesso</li>
                    <li>• Aggiornamenti istantanei</li>
                    <li>• Ideale per spese di gruppo</li>
                </ul>
            </div>
        </div>

        <div id="localMode" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-home text-blue-600 text-2xl mr-3"></i>
                    <h2 class="text-2xl font-bold text-white">Modalità Locale</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="showHelp('locale')" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                        <i class="fas fa-question mr-2"></i>Aiuto
                    </button>
                    <button onclick="backToSelection()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Cambia Modalità
                    </button>
                </div>
            </div>

            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-users text-blue-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Partecipanti</h2>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input type="text" id="participantName" placeholder="Nome partecipante" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="if(event.key==='Enter') addParticipant()">
                    <button onclick="addParticipant()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Aggiungi
                    </button>
                </div>
                
                <div id="participantsList" class="space-y-2"></div>
            </div>

            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-receipt text-green-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Aggiungi Spesa</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <input type="text" id="expenseDescription" placeholder="Descrizione spesa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="expenseAmount" placeholder="Importo €" step="0.01" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="expenseDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        
                        <select id="expensePayer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Chi ha pagato?</option>
                        </select>
                        
                        <button onclick="addExpense()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                        </button>
                    </div>
                    
                    <div>
                        <div id="participantsCheckboxes" class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Dividi tra:</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-list text-purple-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Spese Registrate</h2>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="exportData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-download mr-2"></i>Esporta
                        </button>
                        <button onclick="clearAllData()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm">
                            <i class="fas fa-trash mr-2"></i>Reset
                        </button>
                    </div>
                </div>
                
                <div id="expensesList" class="space-y-3 max-h-60 overflow-y-auto"></div>
            </div>

            <div class="glass-card rounded-xl p-6 shadow-xl">
                <div class="flex items-center mb-4">
                    <i class="fas fa-balance-scale text-orange-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Bilanci</h2>
                </div>
                
                <div id="balancesList" class="space-y-3"></div>
            </div>
        </div>

        <div id="sharedMode" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-cloud text-purple-600 text-2xl mr-3"></i>
                    <h2 class="text-2xl font-bold text-white">Modalità Condivisa</h2>
                </div>
                <div class="flex gap-2">
                    <button onclick="showHelp('condivisa')" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                        <i class="fas fa-question mr-2"></i>Aiuto
                    </button>
                    <button onclick="backToSelection()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Cambia Modalità
                    </button>
                </div>
            </div>

            <div id="sharedSelection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="glass-card rounded-xl p-6 shadow-xl text-center cursor-pointer hover:shadow-2xl transition-shadow" onclick="showCreateGroup()">
                    <i class="fas fa-plus-circle text-green-600 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Crea Nuovo Gruppo</h3>
                    <p class="text-gray-600">Inizia un nuovo gruppo di spese condivise</p>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl text-center cursor-pointer hover:shadow-2xl transition-shadow" onclick="showJoinGroup()">
                    <i class="fas fa-sign-in-alt text-blue-600 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Unisciti a Gruppo</h3>
                    <p class="text-gray-600">Entra in un gruppo esistente con il codice</p>
                </div>
            </div>

            <div id="createGroupForm" class="glass-card rounded-xl p-6 shadow-xl mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Crea Nuovo Gruppo</h3>
                    <button onclick="hideCreateGroup()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <input type="text" id="groupName" placeholder="Nome del gruppo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <textarea id="groupDescription" placeholder="Descrizione (opzionale)" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>
                    <button onclick="createGroup()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Crea Gruppo
                    </button>
                </div>
            </div>

            <div id="joinGroupForm" class="glass-card rounded-xl p-6 shadow-xl mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Unisciti a Gruppo</h3>
                    <button onclick="hideJoinGroup()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <input type="text" id="joinGroupCode" placeholder="Codice gruppo (es. SPESE-ABC123)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="text" id="joinParticipantName" placeholder="Il tuo nome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button onclick="joinGroup()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>Unisciti al Gruppo
                    </button>
                </div>
            </div>

            <div id="groupInterface" class="hidden"></div>
        </div>

        <div id="notification" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform translate-x-full transition-transform duration-300 z-50"></div>
    </div>

    <script>
        const API_BASE 'https://gestione-spese-backend-by-ezio-1038eccc3f3.herokuapp.com/api'
        
        let participants = [];
        let expenses = [];
        let currentMode = null;
        let currentGroup = null;
        let groupParticipants = [];
        let groupExpenses = [];

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expenseDate');
            if (dateInput) {
                dateInput.value = today;
            }
            loadLocalData();
        });

        // Funzioni per il sistema di aiuto
        function showHelp(section = 'generale') {
            document.getElementById('helpModal').classList.remove('hidden');
            showHelpSection(section);
        }

        function hideHelp() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        function showHelpSection(section) {
            // Nascondi tutte le sezioni
            const sections = ['generale', 'locale', 'condivisa', 'faq'];
            sections.forEach(s => {
                document.getElementById(`help-${s}`).classList.add('hidden');
            });
            
            // Rimuovi classe active da tutti i tab
            document.querySelectorAll('.help-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra la sezione selezionata
            document.getElementById(`help-${section}`).classList.remove('hidden');
            
            // Aggiungi classe active al tab corretto
            event.target.classList.add('active');
        }

        // Chiudi modal cliccando fuori
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideHelp();
            }
        });

        function useLocalMode() {
            currentMode = 'local';
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('localMode').classList.remove('hidden');
            document.getElementById('localMode').classList.add('fade-in');
            loadLocalData();
        }

        function useSharedMode() {
            currentMode = 'shared';
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('sharedMode').classList.remove('hidden');
            document.getElementById('sharedMode').classList.add('fade-in');
        }

        function backToSelection() {
            currentMode = null;
            currentGroup = null;
            groupParticipants = [];
            groupExpenses = [];
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('localMode').classList.add('hidden');
            document.getElementById('sharedMode').classList.add('hidden');
            document.getElementById('groupInterface').classList.add('hidden');
            hideCreateGroup();
            hideJoinGroup();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-transform duration-300 z-50 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 3000);
        }

        function saveLocalData() {
            localStorage.setItem('gestione_spese_participants', JSON.stringify(participants));
            localStorage.setItem('gestione_spese_expenses', JSON.stringify(expenses));
        }

        function loadLocalData() {
            const savedParticipants = localStorage.getItem('gestione_spese_participants');
            const savedExpenses = localStorage.getItem('gestione_spese_expenses');
            
            if (savedParticipants) {
                participants = JSON.parse(savedParticipants);
                displayParticipants();
                updateParticipantSelect();
                updateParticipantCheckboxes();
            }
            
            if (savedExpenses) {
                expenses = JSON.parse(savedExpenses);
                displayExpenses();
                calculateBalances();
            }
        }

        function addParticipant() {
            const name = document.getElementById('participantName').value.trim();
            
            if (!name) {
                showNotification('Inserisci un nome', 'error');
                return;
            }
            
            if (participants.includes(name)) {
                showNotification('Partecipante già presente', 'error');
                return;
            }
            
            participants.push(name);
            document.getElementById('participantName').value = '';
            
            displayParticipants();
            updateParticipantSelect();
            updateParticipantCheckboxes();
            saveLocalData();
            showNotification('Partecipante aggiunto');
        }

        function removeParticipant(name) {
            if (confirm(`Rimuovere ${name}?`)) {
                participants = participants.filter(p => p !== name);
                displayParticipants();
                updateParticipantSelect();
                updateParticipantCheckboxes();
                saveLocalData();
                showNotification('Partecipante rimosso');
            }
        }

        function displayParticipants() {
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <button onclick="removeParticipant('${participant}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function updateParticipantSelect() {
            const select = document.getElementById('expensePayer');
            select.innerHTML = '<option value="">Chi ha pagato?</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                select.appendChild(option);
            });
        }

        function updateParticipantCheckboxes() {
            const container = document.getElementById('participantsCheckboxes');
            const label = container.querySelector('label');
            container.innerHTML = '';
            container.appendChild(label);
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="participant_${participant}" value="${participant}" class="mr-2">
                    <label for="participant_${participant}" class="text-sm text-gray-700">${participant}</label>
                `;
                container.appendChild(div);
            });
        }

        function addExpense() {
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const payer = document.getElementById('expensePayer').value;
            
            if (!description || !amount || !date || !payer) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const selectedParticipants = [];
            participants.forEach(participant => {
                const checkbox = document.getElementById(`participant_${participant}`);
                if (checkbox && checkbox.checked) {
                    selectedParticipants.push(participant);
                }
            });
            
            if (selectedParticipants.length === 0) {
                showNotification('Seleziona almeno un partecipante', 'error');
                return;
            }
            
            const expense = {
                id: Date.now(),
                description,
                amount,
                date,
                payer,
                participants: selectedParticipants
            };
            
            expenses.push(expense);
            
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expensePayer').value = '';
            participants.forEach(participant => {
                const checkbox = document.getElementById(`participant_${participant}`);
                if (checkbox) checkbox.checked = false;
            });
            
            displayExpenses();
            calculateBalances();
            saveLocalData();
            showNotification('Spesa aggiunta');
        }

        function displayExpenses() {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            
            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>';
                return;
            }
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-800">${expense.description}</h4>
                        <span class="text-blue-600"><i class="fas fa-home"></i></span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p><strong>€${expense.amount.toFixed(2)}</strong> • ${expense.date} • Pagato da <strong>${expense.payer}</strong></p>
                        <p>Diviso tra: ${expense.participants.join(', ')}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function calculateBalances() {
            const balances = {};
            
            participants.forEach(participant => {
                balances[participant] = 0;
            });
            
            expenses.forEach(expense => {
                const share = expense.amount / expense.participants.length;
                balances[expense.payer] += expense.amount;
                expense.participants.forEach(participant => {
                    balances[participant] -= share;
                });
            });
            
            displayBalances(balances);
        }

        function displayBalances(balances) {
            const list = document.getElementById('balancesList');
            list.innerHTML = '';
            
            if (participants.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Aggiungi partecipanti per vedere i bilanci</p>';
                return;
            }
            
            const balanceDiv = document.createElement('div');
            balanceDiv.className = 'mb-4';
            balanceDiv.innerHTML = '<h3 class="font-bold text-gray-800 mb-2">Bilanci individuali:</h3>';
            
            Object.entries(balances).forEach(([participant, balance]) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-lg ${
                    balance > 0.01 ? 'bg-green-50 border-l-4 border-green-500' :
                    balance < -0.01 ? 'bg-red-50 border-l-4 border-red-500' :
                    'bg-gray-50 border-l-4 border-gray-300'
                }`;
                
                const status = balance > 0.01 ? 'deve ricevere' : balance < -0.01 ? 'deve dare' : 'è in pari';
                const color = balance > 0.01 ? 'text-green-700' : balance < -0.01 ? 'text-red-700' : 'text-gray-700';
                
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <span class="${color} font-bold">€${Math.abs(balance).toFixed(2)} ${status}</span>
                `;
                balanceDiv.appendChild(div);
            });
            
            list.appendChild(balanceDiv);
            
            const settlements = calculateSettlements(balances);
            if (settlements.length > 0) {
                const settlementsDiv = document.createElement('div');
                settlementsDiv.innerHTML = '<h3 class="font-bold text-gray-800 mb-2">Rimborsi suggeriti:</h3>';
                
                settlements.forEach(settlement => {
                    const div = document.createElement('div');
                    div.className = 'bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500';
                    div.innerHTML = `
                        <span class="text-blue-800">
                            <strong>${settlement.from}</strong> deve dare <strong>€${settlement.amount.toFixed(2)}</strong> a <strong>${settlement.to}</strong>
                        </span>
                    `;
                    settlementsDiv.appendChild(div);
                });
                
                list.appendChild(settlementsDiv);
            }
        }

        function calculateSettlements(balances) {
            const settlements = [];
            const debtors = [];
            const creditors = [];
            
            Object.entries(balances).forEach(([person, balance]) => {
                if (balance < -0.01) {
                    debtors.push({ person, amount: Math.abs(balance) });
                } else if (balance > 0.01) {
                    creditors.push({ person, amount: balance });
                }
            });
            
            debtors.sort((a, b) => b.amount - a.amount);
            creditors.sort((a, b) => b.amount - a.amount);
            
            let i = 0, j = 0;
            while (i < debtors.length && j < creditors.length) {
                const debt = debtors[i].amount;
                const credit = creditors[j].amount;
                const amount = Math.min(debt, credit);
                
                settlements.push({
                    from: debtors[i].person,
                    to: creditors[j].person,
                    amount: amount
                });
                
                debtors[i].amount -= amount;
                creditors[j].amount -= amount;
                
                if (debtors[i].amount < 0.01) i++;
                if (creditors[j].amount < 0.01) j++;
            }
            
            return settlements;
        }

        function exportData() {
            const data = {
                participants,
                expenses,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gestione_spese_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Dati esportati');
        }

        function clearAllData() {
            if (confirm('Sei sicuro di voler cancellare tutti i dati? Questa azione non può essere annullata.')) {
                participants = [];
                expenses = [];
                localStorage.removeItem('gestione_spese_participants');
                localStorage.removeItem('gestione_spese_expenses');
                
                displayParticipants();
                updateParticipantSelect();
                updateParticipantCheckboxes();
                displayExpenses();
                calculateBalances();
                
                showNotification('Tutti i dati sono stati eliminati');
            }
        }

        function showCreateGroup() {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('createGroupForm').classList.remove('hidden');
        }

        function hideCreateGroup() {
            document.getElementById('sharedSelection').classList.remove('hidden');
            document.getElementById('createGroupForm').classList.add('hidden');
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        function showJoinGroup() {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('joinGroupForm').classList.remove('hidden');
        }

        function hideJoinGroup() {
            document.getElementById('sharedSelection').classList.remove('hidden');
            document.getElementById('joinGroupForm').classList.add('hidden');
            document.getElementById('joinGroupCode').value = '';
            document.getElementById('joinParticipantName').value = '';
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            
            if (!name) {
                showNotification('Inserisci il nome del gruppo', 'error');
                return;
            }
            
            try {
                showNotification('Creazione gruppo in corso...');
                
                const response = await fetch(`${API_BASE}/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showNotification(`Gruppo creato! Codice: ${data.group.code}`);
                    currentGroup = data.group;
                    
                    setTimeout(() => {
                        loadGroupInterface(data.group);
                    }, 1500);
                } else {
                    showNotification(data.error || 'Errore nella creazione del gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione. Verifica che il backend sia attivo.', 'error');
            }
        }

        // FUNZIONE CORRETTA PER IL BUG DI ACCESSO AI GRUPPI
        async function joinGroup() {
            const code = document.getElementById('joinGroupCode').value.trim().toUpperCase();
            const participantName = document.getElementById('joinParticipantName').value.trim();
            
            if (!code || !participantName) {
                showNotification('Inserisci codice gruppo e nome', 'error');
                return;
            }
            
            try {
                showNotification('Connessione al gruppo...');
                
                // Prima ottieni i dati del gruppo
                const groupResponse = await fetch(`${API_BASE}/groups/${code}`);
                const groupData = await groupResponse.json();
                
                if (!groupResponse.ok || !groupData.success) {
                    showNotification(groupData.error || 'Gruppo non trovato', 'error');
                    return;
                }
                
                // Controlla se il partecipante è già presente
                const existingParticipants = groupData.group.participants || [];
                const isAlreadyParticipant = existingParticipants.includes(participantName);
                
                if (isAlreadyParticipant) {
                    // Se è già presente, entra direttamente senza aggiungere
                    showNotification(`Bentornato nel gruppo ${groupData.group.name}!`);
                    currentGroup = groupData.group;
                    
                    setTimeout(() => {
                        loadGroupInterface(groupData.group);
                    }, 1500);
                } else {
                    // Se non è presente, prova ad aggiungerlo
                    const participantResponse = await fetch(`${API_BASE}/groups/${groupData.group.id}/participants`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: participantName })
                    });
                    
                    const participantData = await participantResponse.json();
                    
                    if (participantResponse.ok && participantData.success) {
                        showNotification(`Unito al gruppo ${groupData.group.name}!`);
                        currentGroup = groupData.group;
                        
                        setTimeout(() => {
                            loadGroupInterface(groupData.group);
                        }, 1500);
                    } else {
                        // Se fallisce l'aggiunta ma il partecipante potrebbe essere già presente
                        if (participantData.error && participantData.error.includes('già presente')) {
                            showNotification(`Bentornato nel gruppo ${groupData.group.name}!`);
                            currentGroup = groupData.group;
                            
                            setTimeout(() => {
                                loadGroupInterface(groupData.group);
                            }, 1500);
                        } else {
                            showNotification(participantData.error || 'Errore nell\'unirsi al gruppo', 'error');
                        }
                    }
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione. Verifica che il backend sia attivo.', 'error');
            }
        }

        function loadGroupInterface(group) {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('createGroupForm').classList.add('hidden');
            document.getElementById('joinGroupForm').classList.add('hidden');
            document.getElementById('groupInterface').classList.remove('hidden');
            
            const groupInterface = document.getElementById('groupInterface');
            groupInterface.innerHTML = `
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">${group.name}</h2>
                            <p class="text-gray-600">${group.description || ''}</p>
                            <p class="text-sm text-gray-500">Codice: <strong>${group.code}</strong></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showHelp('condivisa')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                <i class="fas fa-question mr-2"></i>Aiuto
                            </button>
                            <button onclick="refreshGroupData()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i>Aggiorna
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-users text-blue-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Partecipanti</h2>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="groupParticipantName" placeholder="Nome partecipante" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="if(event.key==='Enter') addGroupParticipant()">
                        <button onclick="addGroupParticipant()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Aggiungi
                        </button>
                    </div>
                    
                    <div id="groupParticipantsList" class="space-y-2"></div>
                </div>

                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-receipt text-green-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Aggiungi Spesa</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <input type="text" id="groupExpenseDescription" placeholder="Descrizione spesa" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="groupExpenseAmount" placeholder="Importo €" step="0.01" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <input type="date" id="groupExpenseDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            </div>
                            
                            <select id="groupExpensePayer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Chi ha pagato?</option>
                            </select>
                            
                            <button onclick="addGroupExpense()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                                <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                            </button>
                        </div>
                        
                        <div>
                            <div id="groupParticipantsCheckboxes" class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Dividi tra:</label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-list text-purple-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Spese del Gruppo</h2>
                    </div>
                    
                    <div id="groupExpensesList" class="space-y-3 max-h-60 overflow-y-auto"></div>
                </div>

                <div class="glass-card rounded-xl p-6 shadow-xl">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-balance-scale text-orange-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Bilanci del Gruppo</h2>
                    </div>
                    
                    <div id="groupBalancesList" class="space-y-3"></div>
                </div>
            `;

            // Imposta la data di oggi
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('groupExpenseDate').value = today;

            // Carica i dati del gruppo
            refreshGroupData();
        }

        async function refreshGroupData() {
            if (!currentGroup) return;
            
            try {
                // Carica partecipanti
                const groupResponse = await fetch(`${API_BASE}/groups/${currentGroup.code}`);
                const groupData = await groupResponse.json();
                
                if (groupResponse.ok && groupData.success) {
                    groupParticipants = groupData.group.participants || [];
                    displayGroupParticipants();
                    updateGroupParticipantSelect();
                    updateGroupParticipantCheckboxes();
                }

                // Carica spese
                const expensesResponse = await fetch(`${API_BASE}/groups/${currentGroup.id}/expenses`);
                const expensesData = await expensesResponse.json();
                
                if (expensesResponse.ok && expensesData.success) {
                    groupExpenses = expensesData.expenses || [];
                    displayGroupExpenses();
                    calculateGroupBalances();
                }
                
            } catch (error) {
                console.error('Errore nel caricamento dati:', error);
                showNotification('Errore nel caricamento dati', 'error');
            }
        }

        async function addGroupParticipant() {
            const name = document.getElementById('groupParticipantName').value.trim();
            
            if (!name) {
                showNotification('Inserisci un nome', 'error');
                return;
            }
            
            if (groupParticipants.includes(name)) {
                showNotification('Partecipante già presente', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.id}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('groupParticipantName').value = '';
                    showNotification('Partecipante aggiunto');
                    refreshGroupData();
                } else {
                    showNotification(data.error || 'Errore nell\'aggiunta del partecipante', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        function displayGroupParticipants() {
            const list = document.getElementById('groupParticipantsList');
            list.innerHTML = '';
            
            groupParticipants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <span class="text-green-600"><i class="fas fa-check"></i></span>
                `;
                list.appendChild(div);
            });
        }

        function updateGroupParticipantSelect() {
            const select = document.getElementById('groupExpensePayer');
            select.innerHTML = '<option value="">Chi ha pagato?</option>';
            
            groupParticipants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                select.appendChild(option);
            });
        }

        function updateGroupParticipantCheckboxes() {
            const container = document.getElementById('groupParticipantsCheckboxes');
            const label = container.querySelector('label');
            container.innerHTML = '';
            container.appendChild(label);
            
            groupParticipants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="group_participant_${participant}" value="${participant}" class="mr-2">
                    <label for="group_participant_${participant}" class="text-sm text-gray-700">${participant}</label>
                `;
                container.appendChild(div);
            });
        }

        async function addGroupExpense() {
            const description = document.getElementById('groupExpenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('groupExpenseAmount').value);
            const date = document.getElementById('groupExpenseDate').value;
            const payer = document.getElementById('groupExpensePayer').value;
            
            if (!description || !amount || !date || !payer) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const selectedParticipants = [];
            groupParticipants.forEach(participant => {
                const checkbox = document.getElementById(`group_participant_${participant}`);
                if (checkbox && checkbox.checked) {
                    selectedParticipants.push(participant);
                }
            });
            
            if (selectedParticipants.length === 0) {
                showNotification('Seleziona almeno un partecipante', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.id}/expenses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description,
                        amount,
                        date,
                        payer,
                        participants: selectedParticipants
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('groupExpenseDescription').value = '';
                    document.getElementById('groupExpenseAmount').value = '';
                    document.getElementById('groupExpensePayer').value = '';
                    groupParticipants.forEach(participant => {
                        const checkbox = document.getElementById(`group_participant_${participant}`);
                        if (checkbox) checkbox.checked = false;
                    });
                    
                    showNotification('Spesa aggiunta');
                    refreshGroupData();
                } else {
                    showNotification(data.error || 'Errore nell\'aggiunta della spesa', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        function displayGroupExpenses() {
            const list = document.getElementById('groupExpensesList');
            list.innerHTML = '';
            
            if (groupExpenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>';
                return;
            }
            
            groupExpenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-800">${expense.description}</h4>
                        <span class="text-green-600"><i class="fas fa-cloud"></i></span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p><strong>€${expense.amount.toFixed(2)}</strong> • ${expense.date} • Pagato da <strong>${expense.payer}</strong></p>
                        <p>Diviso tra: ${expense.participants.join(', ')}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function calculateGroupBalances() {
            const balances = {};
            
            groupParticipants.forEach(participant => {
                balances[participant] = 0;
            });
            
            groupExpenses.forEach(expense => {
                const share = expense.amount / expense.participants.length;
                balances[expense.payer] += expense.amount;
                expense.participants.forEach(participant => {
                    balances[participant] -= share;
                });
            });
            
            displayGroupBalances(balances);
        }

        function displayGroupBalances(balances) {
            const list = document.getElementById('groupBalancesList');
            list.innerHTML = '';
            
            if (groupParticipants.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Aggiungi partecipanti per vedere i bilanci</p>';
                return;
            }
            
            const balanceDiv = document.createElement('div');
            balanceDiv.className = 'mb-4';
            balanceDiv.innerHTML = '<h3 class="font-bold text-gray-800 mb-2">Bilanci individuali:</h3>';
            
            Object.entries(balances).forEach(([participant, balance]) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-lg ${
                    balance > 0.01 ? 'bg-green-50 border-l-4 border-green-500' :
                    balance < -0.01 ? 'bg-red-50 border-l-4 border-red-500' :
                    'bg-gray-50 border-l-4 border-gray-300'
                }`;
                
                const status = balance > 0.01 ? 'deve ricevere' : balance < -0.01 ? 'deve dare' : 'è in pari';
                const color = balance > 0.01 ? 'text-green-700' : balance < -0.01 ? 'text-red-700' : 'text-gray-700';
                
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <span class="${color} font-bold">€${Math.abs(balance).toFixed(2)} ${status}</span>
                `;
                balanceDiv.appendChild(div);
            });
            
            list.appendChild(balanceDiv);
            
            const settlements = calculateSettlements(balances);
            if (settlements.length > 0) {
                const settlementsDiv = document.createElement('div');
                settlementsDiv.innerHTML = '<h3 class="font-bold text-gray-800 mb-2">Rimborsi suggeriti:</h3>';
                
                settlements.forEach(settlement => {
                    const div = document.createElement('div');
                    div.className = 'bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500';
                    div.innerHTML = `
                        <span class="text-blue-800">
                            <strong>${settlement.from}</strong> deve dare <strong>€${settlement.amount.toFixed(2)}</strong> a <strong>${settlement.to}</strong>
                        </span>
                    `;
                    settlementsDiv.appendChild(div);
                });
                
                list.appendChild(settlementsDiv);
            }
    
            // Added functions to allow editing and deleting participants and expenses
    function editParticipant(oldName) {
      const newName = prompt("Inserisci il nuovo nome per " + oldName + ":", oldName);
      if (!newName || newName.trim() === "" || participants.includes(newName)) {
        return;
      }
      // Update participants array
      const index = participants.indexOf(oldName);
      if (index !== -1) {
        participants[index] = newName;
      }
      // Update expenses payer and participants lists
      expenses.forEach(expense => {
        if (expense.payer === oldName) {
          expense.payer = newName;
        }
        expense.participants = expense.participants.map(p => p === oldName ? newName : p);
      });
      updateParticipantSelect();
      updateParticipantCheckboxes();
      displayParticipants();
      displayExpenses();
      calculateBalances();
      saveLocalData();
    }

    // Override removeParticipant to also update expenses
    function removeParticipant(name) {
      if (!confirm("Vuoi cancellare il partecipante '" + name + "'? Verranno rimosse anche le spese associate.")) {
        return;
      }
      // Remove participant from participants array
      const idx = participants.indexOf(name);
      if (idx !== -1) {
        participants.splice(idx, 1);
      }
      // Remove expenses where this person is payer or participant
      expenses = expenses.filter(expense => {
        const isPayer = expense.payer === name;
        const isInvolved = expense.participants.includes(name);
        return !isPayer && !isInvolved;
      });
      updateParticipantSelect();
      updateParticipantCheckboxes();
      displayParticipants();
      displayExpenses();
      calculateBalances();
      saveLocalData();
    }

    // Add functions to edit and remove expenses
    function removeExpense(id) {
      if (!confirm("Vuoi cancellare questa spesa?")) return;
      expenses = expenses.filter(exp => exp.id !== id);
      displayExpenses();
      calculateBalances();
      saveLocalData();
    }

    function editExpense(id) {
      const expense = expenses.find(exp => exp.id === id);
      if (!expense) return;
      const newDesc = prompt("Nuova descrizione:", expense.description) || expense.description;
      const newAmountStr = prompt("Nuovo importo:", expense.amount);
      const newAmount = parseFloat(newAmountStr);
      const newDate = prompt("Nuova data (AAAA-MM-GG):", expense.date) || expense.date;
      const newPayer = prompt("Nuovo pagatore:", expense.payer) || expense.payer;
      const newParticipantsStr = prompt("Nuovi partecipanti separati da virgola:", expense.participants.join(", ")) || expense.participants.join(", ");
      const newParticipants = newParticipantsStr.split(",").map(p => p.trim()).filter(p => p);
      expense.description = newDesc;
      expense.amount = isNaN(newAmount) ? expense.amount : newAmount;
      expense.date = newDate;
      expense.payer = newPayer;
      expense.participants = newParticipants;
      displayExpenses();
      calculateBalances();
      saveLocalData();
    }

    // Override displayParticipants to show edit and delete icons
    function displayParticipants() {
      const list = document.getElementById('participant-list');
      list.innerHTML = '';
      participants.forEach(participant => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between mb-2';
        div.innerHTML = `
          <span class="font-medium text-gray-800">${participant}</span>
          <span>
            <button class="text-blue-500 mr-2" onclick="editParticipant('${participant}')">
              <i class="fas fa-pen"></i>
            </button>
            <button class="text-red-500" onclick="removeParticipant('${participant}')">
              <i class="fas fa-trash"></i>
            </button>
          </span>
        `;
        list.appendChild(div);
      });
    }

    // Override displayExpenses to include edit and delete icons
    function displayExpenses() {
      const list = document.getElementById('expense-list');
      list.innerHTML = '';
      expenses.forEach(expense => {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-gray-100 p-4 rounded mb-2';
        const participantsStr = expense.participants.join(', ');
        div.innerHTML = `
          <div>
            <span class="font-semibold text-blue-800">${expense.description}</span>
            <span class="text-gray-700"> - $${expense.amount.toFixed(2)} - ${expense.date}</span>
            <p class="text-gray-600">${expense.payer} ha pagato. Partecipanti: ${participantsStr}</p>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="editExpense(${expense.id})" class="text-blue-500"><i class="fas fa-pen"></i></button>
            <button onclick="removeExpense(${expense.id})" class="text-red-500"><i class="fas fa-trash"></i></button>
          </div>
        `;
        list.appendChild(div);
      });
    }
}
            // Final override functions for participants and expenses display
    function displayParticipants() {
      const list = document.getElementById('participant-list');
      list.innerHTML = '';
      participants.forEach(function(participant) {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between mb-2';
        div.innerHTML =
          '<span class="font-medium text-gray-800">' + participant + '</span>' +
          '<span>' +
            '<button class="text-blue-500 mr-2" onclick="editParticipant(\'' + participant + '\')">' +
              '<i class="fas fa-pen"></i>' +
            '</button>' +
            '<button class="text-red-500" onclick="removeParticipant(\'' + participant + '\')">' +
              '<i class="fas fa-trash"></i>' +
            '</button>' +
          '</span>';
        list.appendChild(div);
      });
    }

    function displayExpenses() {
      const list = document.getElementById('expense-list');
      list.innerHTML = '';
      expenses.forEach(function(expense) {
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between bg-gray-100 p-4 rounded mb-2';
        const participantsStr = expense.participants.join(', ');
        div.innerHTML =
          '<div>' +
            '<span class="font-semibold text-blue-800">' + expense.description + '</span>' +
            '<span class="text-gray-700"> - $' + expense.amount.toFixed(2) + ' - ' + expense.date + '</span>' +
            '<p class="text-gray-600">' + expense.payer + ' ha pagato. Partecipanti: ' + participantsStr + '</p>' +
          '</div>' +
          '<div class="flex items-center space-x-2">' +
            '<button onclick="editExpense(' + expense.id + ')" class="text-blue-500"><i class="fas fa-pen"></i></button>' +
            '<button onclick="removeExpense(' + expense.id + ')" class="text-red-500"><i class="fas fa-trash"></i></button>' +
          '</div>';
        list.appendChild(div);
      });
    }

    </script>
</body>
</html>

