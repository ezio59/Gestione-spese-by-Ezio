<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione spese by Ezio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mode-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .error-border {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        .success-border {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .hidden { display: none; }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-calculator text-white text-4xl mr-3"></i>
                <h1 class="text-4xl font-bold text-white">Gestione spese by Ezio</h1>
            </div>
            <p class="text-white text-lg opacity-90">Gestisci le tue spese condivise in modo semplice e veloce</p>
        </div>

        <!-- Selezione Modalità -->
        <div id="modeSelection" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <div class="mode-card glass-card rounded-xl p-8 shadow-xl text-center" onclick="useLocalMode()">
                <i class="fas fa-home text-blue-600 text-5xl mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Modalità Locale</h2>
                <p class="text-gray-600 mb-4">Gestisci le spese sul tuo dispositivo</p>
                <ul class="text-sm text-gray-500 text-left space-y-1">
                    <li>• Funziona offline</li>
                    <li>• Dati privati e sicuri</li>
                    <li>• Nessuna configurazione richiesta</li>
                </ul>
            </div>
            
            <div class="mode-card glass-card rounded-xl p-8 shadow-xl text-center" onclick="useSharedMode()">
                <i class="fas fa-cloud text-purple-600 text-5xl mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Modalità Condivisa ⭐</h2>
                <p class="text-gray-600 mb-4">Sincronizzazione in tempo reale</p>
                <ul class="text-sm text-gray-500 text-left space-y-1">
                    <li>• Gruppi con codici di accesso</li>
                    <li>• Aggiornamenti istantanei</li>
                    <li>• Ideale per spese di gruppo</li>
                </ul>
            </div>
        </div>

        <!-- Modalità Locale -->
        <div id="localMode" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-home text-blue-600 text-2xl mr-3"></i>
                    <h2 class="text-2xl font-bold text-white">Modalità Locale</h2>
                </div>
                <button onclick="backToSelection()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Cambia Modalità
                </button>
            </div>

            <!-- Gestione Partecipanti -->
            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-users text-blue-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Partecipanti</h2>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input 
                        type="text" 
                        id="participantName" 
                        placeholder="Nome partecipante" 
                        class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onkeypress="if(event.key==='Enter') addParticipant()"
                    >
                    <button 
                        onclick="addParticipant()" 
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        <i class="fas fa-plus mr-2"></i>Aggiungi
                    </button>
                </div>
                
                <div id="participantsList" class="space-y-2">
                    <!-- I partecipanti verranno aggiunti qui dinamicamente -->
                </div>
            </div>

            <!-- Aggiunta Spese -->
            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-receipt text-green-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Aggiungi Spesa</h2>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="expenseDescription" 
                            placeholder="Descrizione spesa" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input 
                                type="number" 
                                id="expenseAmount" 
                                placeholder="Importo €" 
                                step="0.01" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                            <input 
                                type="date" 
                                id="expenseDate" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                        </div>
                        
                        <select 
                            id="expensePayer" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                            <option value="">Chi ha pagato?</option>
                        </select>
                        
                        <button 
                            onclick="addExpense()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                        </button>
                    </div>
                    
                    <div>
                        <div id="participantsCheckboxes" class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Dividi tra:</label>
                            <!-- Le checkbox verranno aggiunte qui dinamicamente -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista Spese -->
            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-list text-purple-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Spese Registrate</h2>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="exportData()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                        >
                            <i class="fas fa-download mr-2"></i>Esporta
                        </button>
                        <button 
                            onclick="clearAllData()" 
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                        >
                            <i class="fas fa-trash mr-2"></i>Reset
                        </button>
                    </div>
                </div>
                
                <div id="expensesList" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Le spese verranno aggiunte qui dinamicamente -->
                </div>
            </div>

            <!-- Bilanci -->
            <div class="glass-card rounded-xl p-6 shadow-xl">
                <div class="flex items-center mb-4">
                    <i class="fas fa-balance-scale text-orange-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Bilanci</h2>
                </div>
                
                <div id="balancesList" class="space-y-3">
                    <!-- I bilanci verranno calcolati qui dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Modalità Condivisa -->
        <div id="sharedMode" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-cloud text-purple-600 text-2xl mr-3"></i>
                    <h2 class="text-2xl font-bold text-white">Modalità Condivisa</h2>
                </div>
                <button onclick="backToSelection()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Cambia Modalità
                </button>
            </div>

            <!-- Selezione Azione Condivisa -->
            <div id="sharedSelection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="glass-card rounded-xl p-6 shadow-xl text-center cursor-pointer hover:shadow-2xl transition-shadow" onclick="showCreateGroup()">
                    <i class="fas fa-plus-circle text-green-600 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Crea Nuovo Gruppo</h3>
                    <p class="text-gray-600">Inizia un nuovo gruppo di spese condivise</p>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl text-center cursor-pointer hover:shadow-2xl transition-shadow" onclick="showJoinGroup()">
                    <i class="fas fa-sign-in-alt text-blue-600 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Unisciti a Gruppo</h3>
                    <p class="text-gray-600">Entra in un gruppo esistente con il codice</p>
                </div>
            </div>

            <!-- Form Creazione Gruppo -->
            <div id="createGroupForm" class="glass-card rounded-xl p-6 shadow-xl mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Crea Nuovo Gruppo</h3>
                    <button onclick="hideCreateGroup()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="groupName" 
                        placeholder="Nome del gruppo" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                    <textarea 
                        id="groupDescription" 
                        placeholder="Descrizione (opzionale)" 
                        rows="3"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    ></textarea>
                    <button 
                        onclick="createGroup()" 
                        class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                    >
                        <i class="fas fa-plus mr-2"></i>Crea Gruppo
                    </button>
                </div>
            </div>

            <!-- Form Unisciti a Gruppo -->
            <div id="joinGroupForm" class="glass-card rounded-xl p-6 shadow-xl mb-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Unisciti a Gruppo</h3>
                    <button onclick="hideJoinGroup()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="joinGroupCode" 
                        placeholder="Codice gruppo (es. SPESE-ABC123)" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <input 
                        type="text" 
                        id="joinParticipantName" 
                        placeholder="Il tuo nome" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <button 
                        onclick="joinGroup()" 
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        <i class="fas fa-sign-in-alt mr-2"></i>Unisciti al Gruppo
                    </button>
                </div>
            </div>

            <!-- Interfaccia Gruppo Condiviso -->
            <div id="groupInterface" class="hidden">
                <!-- Verrà popolata dinamicamente -->
            </div>
        </div>

        <!-- Notifiche -->
        <div id="notification" class="fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium transform translate-x-full transition-transform duration-300 z-50">
        </div>
    </div>

    <script>
        // === CONFIGURAZIONE BACKEND ===
        const API_BASE = 'https://web-production-38738.up.railway.app/api';
        
        // === VARIABILI GLOBALI ===
        let participants = [];
        let expenses = [];
        let currentMode = null;
        let currentGroup = null;

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', function() {
            // Imposta la data di oggi come default
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('expenseDate');
            if (dateInput) {
                dateInput.value = today;
            }
            
            loadLocalData();
        });

        // === GESTIONE MODALITÀ ===
        function useLocalMode() {
            currentMode = 'local';
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('localMode').classList.remove('hidden');
            document.getElementById('localMode').classList.add('fade-in');
            loadLocalData();
        }

        function useSharedMode() {
            currentMode = 'shared';
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('sharedMode').classList.remove('hidden');
            document.getElementById('sharedMode').classList.add('fade-in');
        }

        function backToSelection() {
            currentMode = null;
            currentGroup = null;
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('localMode').classList.add('hidden');
            document.getElementById('sharedMode').classList.add('hidden');
            document.getElementById('groupInterface').classList.add('hidden');
            
            // Reset forms
            hideCreateGroup();
            hideJoinGroup();
        }

        // === NOTIFICHE ===
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-transform duration-300 z-50 ${
                type === 'error' ? 'bg-red-500' : 'bg-green-500'
            }`;
            notification.style.transform = 'translateX(0)';
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // === MODALITÀ LOCALE ===
        function saveLocalData() {
            localStorage.setItem('gestione_spese_participants', JSON.stringify(participants));
            localStorage.setItem('gestione_spese_expenses', JSON.stringify(expenses));
        }

        function loadLocalData() {
            const savedParticipants = localStorage.getItem('gestione_spese_participants');
            const savedExpenses = localStorage.getItem('gestione_spese_expenses');
            
            if (savedParticipants) {
                participants = JSON.parse(savedParticipants);
                displayParticipants();
                updateParticipantSelect();
                updateParticipantCheckboxes();
            }
            
            if (savedExpenses) {
                expenses = JSON.parse(savedExpenses);
                displayExpenses();
                calculateBalances();
            }
        }

        function addParticipant() {
            const name = document.getElementById('participantName').value.trim();
            
            if (!name) {
                showNotification('Inserisci un nome', 'error');
                return;
            }
            
            if (participants.includes(name)) {
                showNotification('Partecipante già presente', 'error');
                return;
            }
            
            participants.push(name);
            document.getElementById('participantName').value = '';
            
            displayParticipants();
            updateParticipantSelect();
            updateParticipantCheckboxes();
            saveLocalData();
            showNotification('Partecipante aggiunto');
        }

        function removeParticipant(name) {
            if (confirm(`Rimuovere ${name}?`)) {
                participants = participants.filter(p => p !== name);
                displayParticipants();
                updateParticipantSelect();
                updateParticipantCheckboxes();
                saveLocalData();
                showNotification('Partecipante rimosso');
            }
        }

        function displayParticipants() {
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <button onclick="removeParticipant('${participant}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function updateParticipantSelect() {
            const select = document.getElementById('expensePayer');
            select.innerHTML = '<option value="">Chi ha pagato?</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                select.appendChild(option);
            });
        }

        function updateParticipantCheckboxes() {
            const container = document.getElementById('participantsCheckboxes');
            const label = container.querySelector('label');
            container.innerHTML = '';
            container.appendChild(label);
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="participant_${participant}" value="${participant}" class="mr-2">
                    <label for="participant_${participant}" class="text-sm text-gray-700">${participant}</label>
                `;
                container.appendChild(div);
            });
        }

        function addExpense() {
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const payer = document.getElementById('expensePayer').value;
            
            if (!description || !amount || !date || !payer) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const selectedParticipants = [];
            participants.forEach(participant => {
                const checkbox = document.getElementById(`participant_${participant}`);
                if (checkbox && checkbox.checked) {
                    selectedParticipants.push(participant);
                }
            });
            
            if (selectedParticipants.length === 0) {
                showNotification('Seleziona almeno un partecipante', 'error');
                return;
            }
            
            const expense = {
                id: Date.now(),
                description,
                amount,
                date,
                payer,
                participants: selectedParticipants
            };
            
            expenses.push(expense);
            
            // Reset form
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expensePayer').value = '';
            participants.forEach(participant => {
                const checkbox = document.getElementById(`participant_${participant}`);
                if (checkbox) checkbox.checked = false;
            });
            
            displayExpenses();
            calculateBalances();
            saveLocalData();
            showNotification('Spesa aggiunta');
        }

        function removeExpense(id) {
            if (confirm('Rimuovere questa spesa?')) {
                expenses = expenses.filter(e => e.id !== id);
                displayExpenses();
                calculateBalances();
                saveLocalData();
                showNotification('Spesa rimossa');
            }
        }

        function displayExpenses() {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            
            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>';
                return;
            }
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-800">${expense.description}</h4>
                        <button onclick="removeExpense(${expense.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p><strong>€${expense.amount.toFixed(2)}</strong> • ${expense.date} • Pagato da <strong>${expense.payer}</strong></p>
                        <p>Diviso tra: ${expense.participants.join(', ')}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function calculateBalances() {
            const balances = {};
            
            // Inizializza bilanci
            participants.forEach(participant => {
                balances[participant] = 0;
            });
            
            // Calcola bilanci
            expenses.forEach(expense => {
                const share = expense.amount / expense.participants.length;
                
                // Il pagatore ha speso
                balances[expense.payer] += expense.amount;
                
                // Tutti i partecipanti devono la loro quota
                expense.participants.forEach(participant => {
                    balances[participant] -= share;
                });
            });
            
            displayBalances(balances);
        }

        function displayBalances(balances) {
            const list = document.getElementById('balancesList');
            list.innerHTML = '';
            
            if (participants.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Aggiungi partecipanti per vedere i bilanci</p>';
                return;
            }
            
            // Mostra bilanci individuali
            const balanceDiv = document.createElement('div');
            balanceDiv.className = 'mb-4';
            balanceDiv.innerHTML = '<h3 class="font-bold text-gray-800 mb-2">Bilanci individuali:</h3>';
            
            Object.entries(balances).forEach(([participant, balance]) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-lg ${
                    balance > 0.01 ? 'bg-green-50 border-l-4 border-green-500' :
                    balance < -0.01 ? 'bg-red-50 border-l-4 border-red-500' :
                    'bg-gray-50 border-l-4 border-gray-300'
                }`;
                
                const status = balance > 0.01 ? 'deve ricevere' : balance < -0.01 ? 'deve dare' : 'è in pari';
                const color = balance > 0.01 ? 'text-green-700' : balance < -0.01 ? 'text-red-700' : 'text-gray-700';
                
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <span class="${color} font-bold">€${Math.abs(balance).toFixed(2)} ${status}</span>
                `;
                balanceDiv.appendChild(div);
            });
            
            list.appendChild(balanceDiv);
            
            // Calcola rimborsi ottimali
            const settlements = calculateSettlements(balances);
            if (settlements.length > 0) {
                const settlementsDiv = document.createElement('div');
                settlementsDiv.innerHTML = '<h3 class="font-bold text-gray-800 mb-2">Rimborsi suggeriti:</h3>';
                
                settlements.forEach(settlement => {
                    const div = document.createElement('div');
                    div.className = 'bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500';
                    div.innerHTML = `
                        <span class="text-blue-800">
                            <strong>${settlement.from}</strong> deve dare <strong>€${settlement.amount.toFixed(2)}</strong> a <strong>${settlement.to}</strong>
                        </span>
                    `;
                    settlementsDiv.appendChild(div);
                });
                
                list.appendChild(settlementsDiv);
            }
        }

        function calculateSettlements(balances) {
            const settlements = [];
            const creditors = [];
            const debtors = [];
            
            Object.entries(balances).forEach(([participant, balance]) => {
                if (balance > 0.01) {
                    creditors.push({ name: participant, amount: balance });
                } else if (balance < -0.01) {
                    debtors.push({ name: participant, amount: -balance });
                }
            });
            
            creditors.sort((a, b) => b.amount - a.amount);
            debtors.sort((a, b) => b.amount - a.amount);
            
            let i = 0, j = 0;
            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];
                const amount = Math.min(creditor.amount, debtor.amount);
                
                settlements.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amount
                });
                
                creditor.amount -= amount;
                debtor.amount -= amount;
                
                if (creditor.amount < 0.01) i++;
                if (debtor.amount < 0.01) j++;
            }
            
            return settlements;
        }

        function exportData() {
            const data = {
                participants,
                expenses,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gestione-spese-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Dati esportati');
        }

        function clearAllData() {
            if (confirm('Eliminare tutti i dati? Questa azione non può essere annullata.')) {
                participants = [];
                expenses = [];
                localStorage.removeItem('gestione_spese_participants');
                localStorage.removeItem('gestione_spese_expenses');
                
                displayParticipants();
                updateParticipantSelect();
                updateParticipantCheckboxes();
                displayExpenses();
                calculateBalances();
                
                showNotification('Tutti i dati sono stati eliminati');
            }
        }

        // === MODALITÀ CONDIVISA ===
        
        function showCreateGroup() {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('createGroupForm').classList.remove('hidden');
        }

        function hideCreateGroup() {
            document.getElementById('sharedSelection').classList.remove('hidden');
            document.getElementById('createGroupForm').classList.add('hidden');
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        function showJoinGroup() {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('joinGroupForm').classList.remove('hidden');
        }

        function hideJoinGroup() {
            document.getElementById('sharedSelection').classList.remove('hidden');
            document.getElementById('joinGroupForm').classList.add('hidden');
            document.getElementById('joinGroupCode').value = '';
            document.getElementById('joinParticipantName').value = '';
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            
            if (!name) {
                showNotification('Inserisci il nome del gruppo', 'error');
                return;
            }
            
            try {
                showNotification('Creazione gruppo in corso...');
                
                const response = await fetch(`${API_BASE}/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showNotification(`Gruppo creato! Codice: ${data.group.code}`);
                    currentGroup = data.group;
                    
                    // Carica l'interfaccia del gruppo
                    setTimeout(() => {
                        loadGroupInterface(data.group);
                    }, 1500);
                } else {
                    showNotification(data.error || 'Errore nella creazione del gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione. Verifica che il backend sia attivo.', 'error');
            }
        }

        async function joinGroup() {
            const code = document.getElementById('joinGroupCode').value.trim().toUpperCase();
            const participantName = document.getElementById('joinParticipantName').value.trim();
            
            if (!code || !participantName) {
                showNotification('Inserisci codice gruppo e nome', 'error');
                return;
            }
            
            try {
                showNotification('Connessione al gruppo...');
                
                // Prima ottieni le info del gruppo
                const groupResponse = await fetch(`${API_BASE}/groups/${code}`);
                const groupData = await groupResponse.json();
                
                if (!groupResponse.ok || !groupData.success) {
                    showNotification(groupData.error || 'Gruppo non trovato', 'error');
                    return;
                }
                
                // Poi aggiungi il partecipante
                const participantResponse = await fetch(`${API_BASE}/groups/${groupData.group.id}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: participantName })
                });
                
                const participantData = await participantResponse.json();
                
                if (participantResponse.ok && participantData.success) {
                    showNotification(`Unito al gruppo ${groupData.group.name}!`);
                    currentGroup = groupData.group;
                    
                    // Carica l'interfaccia del gruppo
                    setTimeout(() => {
                        loadGroupInterface(groupData.group);
                    }, 1500);
                } else {
                    showNotification(participantData.error || 'Errore nell\'unirsi al gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione. Verifica che il backend sia attivo.', 'error');
            }
        }

        function loadGroupInterface(group) {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('createGroupForm').classList.add('hidden');
            document.getElementById('joinGroupForm').classList.add('hidden');
            document.getElementById('groupInterface').classList.remove('hidden');
            
            const groupInterface = document.getElementById('groupInterface');
            groupInterface.innerHTML = `
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">${group.name}</h2>
                            <p class="text-gray-600">${group.description || ''}</p>
                            <p class="text-sm text-gray-500">Codice: <strong>${group.code}</strong></p>
                        </div>
                        <button onclick="refreshGroupData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Aggiorna
                        </button>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Partecipanti</h3>
                    <div id="sharedParticipantsList" class="space-y-2 mb-4">
                        <!-- Partecipanti verranno caricati qui -->
                    </div>
                    <div class="flex gap-2">
                        <input 
                            type="text" 
                            id="newParticipantName" 
                            placeholder="Nome nuovo partecipante" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <button 
                            onclick="addSharedParticipant()" 
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            <i class="fas fa-plus mr-2"></i>Aggiungi
                        </button>
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Aggiungi Spesa</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input 
                            type="text" 
                            id="sharedExpenseDescription" 
                            placeholder="Descrizione spesa" 
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                        <input 
                            type="number" 
                            id="sharedExpenseAmount" 
                            placeholder="Importo €" 
                            step="0.01" 
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                        <select 
                            id="sharedExpensePayer" 
                            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                            <option value="">Chi ha pagato?</option>
                        </select>
                        <button 
                            onclick="addSharedExpense()" 
                            class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                        </button>
                    </div>
                    <div id="sharedParticipantsCheckboxes" class="mt-4">
                        <!-- Checkbox partecipanti verranno aggiunte qui -->
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Spese del Gruppo</h3>
                    <div id="sharedExpensesList" class="space-y-3">
                        <!-- Spese verranno caricate qui -->
                    </div>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Bilanci del Gruppo</h3>
                    <div id="sharedBalancesList" class="space-y-3">
                        <!-- Bilanci verranno calcolati qui -->
                    </div>
                </div>
            `;
            
            // Carica i dati del gruppo
            refreshGroupData();
        }

        async function refreshGroupData() {
            if (!currentGroup) return;
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    displaySharedParticipants(data.participants);
                    displaySharedExpenses(data.expenses);
                    updateSharedParticipantSelect(data.participants);
                    updateSharedParticipantCheckboxes(data.participants);
                    loadSharedBalances();
                } else {
                    showNotification('Errore nel caricare i dati del gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        function displaySharedParticipants(participants) {
            const list = document.getElementById('sharedParticipantsList');
            list.innerHTML = '';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant.name}</span>
                    <span class="text-sm text-gray-500">ID: ${participant.id}</span>
                `;
                list.appendChild(div);
            });
        }

        function displaySharedExpenses(expenses) {
            const list = document.getElementById('sharedExpensesList');
            list.innerHTML = '';
            
            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>';
                return;
            }
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-medium text-gray-800">${expense.description}</h4>
                    </div>
                    <div class="text-sm text-gray-600">
                        <p><strong>€${expense.amount.toFixed(2)}</strong> • Pagato da <strong>${expense.payer_id}</strong></p>
                        <p>Partecipanti: ${expense.participants.length}</p>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function updateSharedParticipantSelect(participants) {
            const select = document.getElementById('sharedExpensePayer');
            select.innerHTML = '<option value="">Chi ha pagato?</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant.id;
                option.textContent = participant.name;
                select.appendChild(option);
            });
        }

        function updateSharedParticipantCheckboxes(participants) {
            const container = document.getElementById('sharedParticipantsCheckboxes');
            container.innerHTML = '<label class="text-sm font-medium text-gray-700 block mb-2">Dividi tra:</label>';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center mb-2';
                div.innerHTML = `
                    <input type="checkbox" id="shared_participant_${participant.id}" value="${participant.id}" class="mr-2">
                    <label for="shared_participant_${participant.id}" class="text-sm text-gray-700">${participant.name}</label>
                `;
                container.appendChild(div);
            });
        }

        async function addSharedParticipant() {
            const name = document.getElementById('newParticipantName').value.trim();
            
            if (!name) {
                showNotification('Inserisci un nome', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.id}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    document.getElementById('newParticipantName').value = '';
                    showNotification('Partecipante aggiunto');
                    refreshGroupData();
                } else {
                    showNotification(data.error || 'Errore nell\'aggiungere il partecipante', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function addSharedExpense() {
            const description = document.getElementById('sharedExpenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('sharedExpenseAmount').value);
            const payerId = document.getElementById('sharedExpensePayer').value;
            
            if (!description || !amount || !payerId) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const selectedParticipants = [];
            const checkboxes = document.querySelectorAll('#sharedParticipantsCheckboxes input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedParticipants.push(checkbox.value);
            });
            
            if (selectedParticipants.length === 0) {
                showNotification('Seleziona almeno un partecipante', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.id}/expenses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description,
                        amount,
                        payer_id: payerId,
                        participants: selectedParticipants
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Reset form
                    document.getElementById('sharedExpenseDescription').value = '';
                    document.getElementById('sharedExpenseAmount').value = '';
                    document.getElementById('sharedExpensePayer').value = '';
                    checkboxes.forEach(checkbox => checkbox.checked = false);
                    
                    showNotification('Spesa aggiunta');
                    refreshGroupData();
                } else {
                    showNotification(data.error || 'Errore nell\'aggiungere la spesa', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function loadSharedBalances() {
            if (!currentGroup) return;
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.id}/balance`);
                const data = await response.json();
                
                if (response.ok && data.success) {
                    displaySharedBalances(data.balances, data.settlements);
                } else {
                    showNotification('Errore nel caricare i bilanci', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        function displaySharedBalances(balances, settlements) {
            const list = document.getElementById('sharedBalancesList');
            list.innerHTML = '';
            
            // Mostra bilanci individuali
            const balanceDiv = document.createElement('div');
            balanceDiv.className = 'mb-4';
            balanceDiv.innerHTML = '<h4 class="font-bold text-gray-800 mb-2">Bilanci individuali:</h4>';
            
            Object.entries(balances).forEach(([participant, balance]) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-lg ${
                    balance > 0.01 ? 'bg-green-50 border-l-4 border-green-500' :
                    balance < -0.01 ? 'bg-red-50 border-l-4 border-red-500' :
                    'bg-gray-50 border-l-4 border-gray-300'
                }`;
                
                const status = balance > 0.01 ? 'deve ricevere' : balance < -0.01 ? 'deve dare' : 'è in pari';
                const color = balance > 0.01 ? 'text-green-700' : balance < -0.01 ? 'text-red-700' : 'text-gray-700';
                
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <span class="${color} font-bold">€${Math.abs(balance).toFixed(2)} ${status}</span>
                `;
                balanceDiv.appendChild(div);
            });
            
            list.appendChild(balanceDiv);
            
            // Mostra rimborsi suggeriti
            if (settlements && settlements.length > 0) {
                const settlementsDiv = document.createElement('div');
                settlementsDiv.innerHTML = '<h4 class="font-bold text-gray-800 mb-2">Rimborsi suggeriti:</h4>';
                
                settlements.forEach(settlement => {
                    const div = document.createElement('div');
                    div.className = 'bg-blue-50 p-3 rounded-lg border-l-4 border-blue-500';
                    div.innerHTML = `
                        <span class="text-blue-800">
                            <strong>${settlement.from}</strong> deve dare <strong>€${settlement.amount.toFixed(2)}</strong> a <strong>${settlement.to}</strong>
                        </span>
                    `;
                    settlementsDiv.appendChild(div);
                });
                
                list.appendChild(settlementsDiv);
            }
        }
    </script>
</body>
</html>

