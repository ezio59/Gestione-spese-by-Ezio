<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione spese by Ezio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .mode-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .error-border {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
        }
        .success-border {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        .hidden { display: none; }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-calculator text-white text-4xl mr-3"></i>
                <h1 class="text-4xl font-bold text-white">Gestione spese by Ezio</h1>
            </div>
            <p class="text-white text-lg opacity-90" id="subtitle">Scegli la modalità di utilizzo</p>
        </div>

        <!-- Selezione Modalità -->
        <div id="modeSelection" class="fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <!-- Modalità Locale -->
                <div class="mode-card glass-card rounded-xl p-8 shadow-xl text-center" onclick="selectMode('local')">
                    <div class="mb-6">
                        <i class="fas fa-laptop text-blue-600 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Modalità Locale</h2>
                        <div class="inline-block bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium mb-4">
                            Gratuita
                        </div>
                    </div>
                    
                    <div class="text-left space-y-3 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Gestione spese sul tuo dispositivo</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Nessuna configurazione richiesta</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Funziona offline</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Dati privati e sicuri</span>
                        </div>
                    </div>
                    
                    <button class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Usa Modalità Locale
                    </button>
                </div>

                <!-- Modalità Condivisa -->
                <div class="mode-card glass-card rounded-xl p-8 shadow-xl text-center" onclick="selectMode('shared')">
                    <div class="mb-6">
                        <i class="fas fa-cloud text-purple-600 text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-800 mb-2">Modalità Condivisa</h2>
                        <div class="inline-block bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium mb-4">
                            ⭐ Nuovo!
                        </div>
                    </div>
                    
                    <div class="text-left space-y-3 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Sincronizzazione in tempo reale</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Gruppi con codici di accesso</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Ideale per spese di gruppo</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check text-green-500 mr-3"></i>
                            <span class="text-gray-700">Calcolo bilanci automatico</span>
                        </div>
                    </div>
                    
                    <button class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-purple-700 transition-colors">
                        Usa Modalità Condivisa
                    </button>
                </div>
            </div>

            <!-- Info aggiuntive -->
            <div class="glass-card rounded-xl p-6 shadow-xl text-center">
                <div class="flex items-center justify-center mb-4">
                    <i class="fas fa-info-circle text-blue-600 text-xl mr-2"></i>
                    <h3 class="text-lg font-bold text-gray-800">Informazioni</h3>
                </div>
                <p class="text-gray-700 mb-4">
                    Puoi cambiare modalità in qualsiasi momento. La modalità locale funziona completamente offline, 
                    mentre quella condivisa richiede una connessione internet per la sincronizzazione.
                </p>
                <div class="flex flex-wrap justify-center gap-4 text-sm text-gray-600">
                    <span><i class="fas fa-shield-alt mr-1"></i> Dati sicuri</span>
                    <span><i class="fas fa-mobile-alt mr-1"></i> Responsive</span>
                    <span><i class="fas fa-code mr-1"></i> Open Source</span>
                </div>
            </div>
        </div>

        <!-- Modalità Locale -->
        <div id="localMode" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-laptop text-blue-600 text-2xl mr-3"></i>
                    <h2 class="text-2xl font-bold text-white">Modalità Locale</h2>
                </div>
                <button onclick="backToSelection()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Cambia Modalità
                </button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Sezione Partecipanti -->
                <div class="glass-card rounded-xl p-6 shadow-xl">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-users text-blue-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Partecipanti</h2>
                    </div>
                    
                    <div class="flex gap-2 mb-4">
                        <input 
                            type="text" 
                            id="participantInput" 
                            placeholder="Nome partecipante" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onkeypress="if(event.key==='Enter') addParticipant()"
                        >
                        <button 
                            onclick="addParticipant()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    
                    <div id="participantsList" class="space-y-2 max-h-40 overflow-y-auto">
                        <!-- I partecipanti verranno aggiunti qui dinamicamente -->
                    </div>
                </div>

                <!-- Sezione Spese -->
                <div class="glass-card rounded-xl p-6 shadow-xl">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-receipt text-green-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Aggiungi Spesa</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="expenseDescription" 
                            placeholder="Descrizione spesa" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                        
                        <div class="grid grid-cols-2 gap-2">
                            <input 
                                type="number" 
                                id="expenseAmount" 
                                placeholder="Importo €" 
                                step="0.01" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                            <input 
                                type="date" 
                                id="expenseDate" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            >
                        </div>
                        
                        <select 
                            id="expensePayer" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                        >
                            <option value="">Chi ha pagato?</option>
                        </select>
                        
                        <div id="participantsCheckboxes" class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Dividi tra:</label>
                            <!-- Le checkbox verranno aggiunte qui dinamicamente -->
                        </div>
                        
                        <button 
                            onclick="addExpense()" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lista Spese -->
            <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-list text-purple-600 text-xl mr-3"></i>
                        <h2 class="text-xl font-bold text-gray-800">Spese Registrate</h2>
                    </div>
                    <div class="flex gap-2">
                        <button 
                            onclick="exportData()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm"
                        >
                            <i class="fas fa-download mr-2"></i>Esporta
                        </button>
                        <button 
                            onclick="clearAllData()" 
                            class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm"
                        >
                            <i class="fas fa-trash mr-2"></i>Reset
                        </button>
                    </div>
                </div>
                
                <div id="expensesList" class="space-y-3 max-h-60 overflow-y-auto">
                    <!-- Le spese verranno aggiunte qui dinamicamente -->
                </div>
            </div>

            <!-- Bilanci -->
            <div class="glass-card rounded-xl p-6 shadow-xl">
                <div class="flex items-center mb-4">
                    <i class="fas fa-balance-scale text-orange-600 text-xl mr-3"></i>
                    <h2 class="text-xl font-bold text-gray-800">Bilanci</h2>
                </div>
                
                <div id="balancesList" class="space-y-3">
                    <!-- I bilanci verranno calcolati qui dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Modalità Condivisa -->
        <div id="sharedMode" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i class="fas fa-cloud text-purple-600 text-2xl mr-3"></i>
                    <h2 class="text-2xl font-bold text-white">Modalità Condivisa</h2>
                </div>
                <button onclick="backToSelection()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Cambia Modalità
                </button>
            </div>

            <!-- Selezione Azione Condivisa -->
            <div id="sharedSelection" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="glass-card rounded-xl p-6 shadow-xl text-center cursor-pointer hover:shadow-2xl transition-shadow" onclick="showCreateGroup()">
                    <i class="fas fa-plus-circle text-green-600 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Crea Nuovo Gruppo</h3>
                    <p class="text-gray-600">Inizia un nuovo gruppo di spese condivise</p>
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl text-center cursor-pointer hover:shadow-2xl transition-shadow" onclick="showJoinGroup()">
                    <i class="fas fa-sign-in-alt text-blue-600 text-4xl mb-4"></i>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Unisciti a Gruppo</h3>
                    <p class="text-gray-600">Entra in un gruppo esistente con il codice</p>
                </div>
            </div>

            <!-- Crea Gruppo -->
            <div id="createGroupForm" class="hidden glass-card rounded-xl p-6 shadow-xl mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-plus-circle text-green-600 mr-2"></i>Crea Nuovo Gruppo
                </h3>
                
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="groupName" 
                        placeholder="Nome del gruppo (es. Vacanza in Sicilia)" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                    <input 
                        type="text" 
                        id="groupDescription" 
                        placeholder="Descrizione (opzionale)" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                    
                    <div class="flex gap-2">
                        <button 
                            onclick="createGroup()" 
                            class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors"
                        >
                            <i class="fas fa-plus mr-2"></i>Crea Gruppo
                        </button>
                        <button 
                            onclick="hideCreateGroup()" 
                            class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"
                        >
                            Annulla
                        </button>
                    </div>
                </div>
            </div>

            <!-- Unisciti a Gruppo -->
            <div id="joinGroupForm" class="hidden glass-card rounded-xl p-6 shadow-xl mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-sign-in-alt text-blue-600 mr-2"></i>Unisciti a Gruppo
                </h3>
                
                <div class="space-y-4">
                    <input 
                        type="text" 
                        id="joinGroupCode" 
                        placeholder="Codice gruppo (es. SPESE-ABC12345)" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        style="text-transform: uppercase;"
                    >
                    <input 
                        type="text" 
                        id="joinParticipantName" 
                        placeholder="Il tuo nome" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    
                    <div class="flex gap-2">
                        <button 
                            onclick="joinGroup()" 
                            class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            <i class="fas fa-sign-in-alt mr-2"></i>Unisciti
                        </button>
                        <button 
                            onclick="hideJoinGroup()" 
                            class="bg-gray-500 text-white py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors"
                        >
                            Annulla
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gestione Gruppo -->
            <div id="groupManagement" class="hidden">
                <!-- Il contenuto del gruppo verrà caricato qui dinamicamente -->
            </div>

            <!-- Messaggio di stato per modalità condivisa -->
            <div class="glass-card rounded-xl p-6 shadow-xl text-center">
                <div class="mb-4">
                    <i class="fas fa-info-circle text-blue-600 text-3xl mb-2"></i>
                    <h3 class="text-lg font-bold text-gray-800">Modalità Condivisa</h3>
                </div>
                <p class="text-gray-700 mb-4">
                    La modalità condivisa permette di sincronizzare le spese in tempo reale tra più dispositivi. 
                    Perfetta per vacanze, cene di gruppo e spese condivise.
                </p>
                <div class="text-sm text-gray-600">
                    <i class="fas fa-shield-alt mr-1"></i> I tuoi dati sono protetti e sincronizzati in modo sicuro
                </div>
            </div>
        </div>

        <!-- Messaggi di notifica -->
        <div id="notification" class="fixed top-4 right-4 hidden">
            <div class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
                <span id="notificationText"></span>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let currentMode = null;
        let participants = [];
        let expenses = [];
        let currentGroup = null;

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Imposta la data di oggi come default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
            
            // Carica dati salvati per modalità locale
            loadLocalData();
        });

        // Gestione selezione modalità
        function selectMode(mode) {
            currentMode = mode;
            document.getElementById('modeSelection').classList.add('hidden');
            
            if (mode === 'local') {
                document.getElementById('localMode').classList.remove('hidden');
                document.getElementById('subtitle').textContent = 'Modalità Locale - Gestione spese offline';
                updateParticipantSelect();
                updateParticipantCheckboxes();
                displayExpenses();
                calculateBalances();
            } else if (mode === 'shared') {
                document.getElementById('sharedMode').classList.remove('hidden');
                document.getElementById('subtitle').textContent = 'Modalità Condivisa - Sincronizzazione in tempo reale';
            }
        }

        function backToSelection() {
            currentMode = null;
            document.getElementById('modeSelection').classList.remove('hidden');
            document.getElementById('localMode').classList.add('hidden');
            document.getElementById('sharedMode').classList.add('hidden');
            document.getElementById('subtitle').textContent = 'Scegli la modalità di utilizzo';
            
            // Reset modalità condivisa
            hideCreateGroup();
            hideJoinGroup();
            document.getElementById('groupManagement').classList.add('hidden');
            document.getElementById('sharedSelection').classList.remove('hidden');
        }

        // === MODALITÀ LOCALE ===
        
        function addParticipant() {
            const input = document.getElementById('participantInput');
            const name = input.value.trim();
            
            if (name === '') {
                showNotification('Inserisci un nome valido', 'error');
                return;
            }
            
            if (participants.includes(name)) {
                showNotification('Partecipante già presente', 'error');
                return;
            }
            
            participants.push(name);
            input.value = '';
            updateParticipantsList();
            updateParticipantSelect();
            updateParticipantCheckboxes();
            saveLocalData();
            showNotification('Partecipante aggiunto');
        }

        function removeParticipant(name) {
            if (confirm(`Rimuovere ${name}? Verranno eliminate anche le sue spese.`)) {
                participants = participants.filter(p => p !== name);
                expenses = expenses.filter(e => e.payer !== name && !e.participants.includes(name));
                updateParticipantsList();
                updateParticipantSelect();
                updateParticipantCheckboxes();
                displayExpenses();
                calculateBalances();
                saveLocalData();
                showNotification('Partecipante rimosso');
            }
        }

        function updateParticipantsList() {
            const list = document.getElementById('participantsList');
            list.innerHTML = '';
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 p-3 rounded-lg';
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <button onclick="removeParticipant('${participant}')" class="text-red-500 hover:text-red-700">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function updateParticipantSelect() {
            const select = document.getElementById('expensePayer');
            select.innerHTML = '<option value="">Chi ha pagato?</option>';
            
            participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant;
                option.textContent = participant;
                select.appendChild(option);
            });
        }

        function updateParticipantCheckboxes() {
            const container = document.getElementById('participantsCheckboxes');
            const label = container.querySelector('label');
            container.innerHTML = '';
            container.appendChild(label);
            
            participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="participant_${participant}" value="${participant}" class="mr-2">
                    <label for="participant_${participant}" class="text-sm text-gray-700">${participant}</label>
                `;
                container.appendChild(div);
            });
        }

        function addExpense() {
            const description = document.getElementById('expenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const date = document.getElementById('expenseDate').value;
            const payer = document.getElementById('expensePayer').value;
            
            if (!description || !amount || !date || !payer) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const selectedParticipants = [];
            participants.forEach(participant => {
                const checkbox = document.getElementById(`participant_${participant}`);
                if (checkbox && checkbox.checked) {
                    selectedParticipants.push(participant);
                }
            });
            
            if (selectedParticipants.length === 0) {
                showNotification('Seleziona almeno un partecipante', 'error');
                return;
            }
            
            const expense = {
                id: Date.now(),
                description,
                amount,
                date,
                payer,
                participants: selectedParticipants
            };
            
            expenses.push(expense);
            
            // Reset form
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expensePayer').value = '';
            participants.forEach(participant => {
                const checkbox = document.getElementById(`participant_${participant}`);
                if (checkbox) checkbox.checked = false;
            });
            
            displayExpenses();
            calculateBalances();
            saveLocalData();
            showNotification('Spesa aggiunta');
        }

        function removeExpense(id) {
            if (confirm('Rimuovere questa spesa?')) {
                expenses = expenses.filter(e => e.id !== id);
                displayExpenses();
                calculateBalances();
                saveLocalData();
                showNotification('Spesa rimossa');
            }
        }

        function displayExpenses() {
            const list = document.getElementById('expensesList');
            list.innerHTML = '';
            
            if (expenses.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>';
                return;
            }
            
            expenses.forEach(expense => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 p-4 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-medium text-gray-800">${expense.description}</h4>
                            <p class="text-sm text-gray-600">€${expense.amount.toFixed(2)} - ${expense.date}</p>
                            <p class="text-sm text-gray-600">Pagato da: ${expense.payer}</p>
                            <p class="text-sm text-gray-600">Diviso tra: ${expense.participants.join(', ')}</p>
                            <p class="text-sm text-gray-600">€${(expense.amount / expense.participants.length).toFixed(2)} a persona</p>
                        </div>
                        <button onclick="removeExpense(${expense.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function calculateBalances() {
            const balances = {};
            
            // Inizializza bilanci
            participants.forEach(participant => {
                balances[participant] = 0;
            });
            
            // Calcola bilanci
            expenses.forEach(expense => {
                const sharePerPerson = expense.amount / expense.participants.length;
                
                // Il pagatore riceve credito
                balances[expense.payer] += expense.amount;
                
                // Ogni partecipante deve la sua quota
                expense.participants.forEach(participant => {
                    balances[participant] -= sharePerPerson;
                });
            });
            
            displayBalances(balances);
        }

        function displayBalances(balances) {
            const list = document.getElementById('balancesList');
            list.innerHTML = '';
            
            if (participants.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-4">Aggiungi partecipanti per vedere i bilanci</p>';
                return;
            }
            
            // Mostra bilanci individuali
            participants.forEach(participant => {
                const balance = balances[participant];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-lg';
                
                let balanceClass = 'text-gray-800';
                let balanceText = '€0.00';
                let statusIcon = 'fas fa-equals';
                
                if (balance > 0.01) {
                    balanceClass = 'text-green-600 font-medium';
                    balanceText = `+€${balance.toFixed(2)}`;
                    statusIcon = 'fas fa-arrow-up';
                } else if (balance < -0.01) {
                    balanceClass = 'text-red-600 font-medium';
                    balanceText = `€${balance.toFixed(2)}`;
                    statusIcon = 'fas fa-arrow-down';
                }
                
                div.innerHTML = `
                    <span class="font-medium text-gray-800">${participant}</span>
                    <div class="flex items-center">
                        <i class="${statusIcon} ${balanceClass} mr-2"></i>
                        <span class="${balanceClass}">${balanceText}</span>
                    </div>
                `;
                list.appendChild(div);
            });
            
            // Calcola e mostra rimborsi
            const reimbursements = calculateReimbursements(balances);
            if (reimbursements.length > 0) {
                const reimbursementDiv = document.createElement('div');
                reimbursementDiv.className = 'mt-4 p-4 bg-blue-50 rounded-lg';
                reimbursementDiv.innerHTML = '<h4 class="font-medium text-blue-800 mb-2"><i class="fas fa-exchange-alt mr-2"></i>Rimborsi suggeriti:</h4>';
                
                reimbursements.forEach(reimb => {
                    const p = document.createElement('p');
                    p.className = 'text-sm text-blue-700';
                    p.textContent = `${reimb.from} deve dare €${reimb.amount.toFixed(2)} a ${reimb.to}`;
                    reimbursementDiv.appendChild(p);
                });
                
                list.appendChild(reimbursementDiv);
            }
        }

        function calculateReimbursements(balances) {
            const creditors = [];
            const debtors = [];
            
            Object.entries(balances).forEach(([person, balance]) => {
                if (balance > 0.01) {
                    creditors.push({ person, amount: balance });
                } else if (balance < -0.01) {
                    debtors.push({ person, amount: -balance });
                }
            });
            
            const reimbursements = [];
            let i = 0, j = 0;
            
            while (i < creditors.length && j < debtors.length) {
                const creditor = creditors[i];
                const debtor = debtors[j];
                const amount = Math.min(creditor.amount, debtor.amount);
                
                if (amount > 0.01) {
                    reimbursements.push({
                        from: debtor.person,
                        to: creditor.person,
                        amount: amount
                    });
                }
                
                creditor.amount -= amount;
                debtor.amount -= amount;
                
                if (creditor.amount < 0.01) i++;
                if (debtor.amount < 0.01) j++;
            }
            
            return reimbursements;
        }

        function exportData() {
            const data = {
                participants,
                expenses,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `spese_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('Dati esportati');
        }

        function clearAllData() {
            if (confirm('Eliminare tutti i dati? Questa azione non può essere annullata.')) {
                participants = [];
                expenses = [];
                updateParticipantsList();
                updateParticipantSelect();
                updateParticipantCheckboxes();
                displayExpenses();
                calculateBalances();
                saveLocalData();
                showNotification('Tutti i dati sono stati eliminati');
            }
        }

        function saveLocalData() {
            localStorage.setItem('gestione_spese_participants', JSON.stringify(participants));
            localStorage.setItem('gestione_spese_expenses', JSON.stringify(expenses));
        }

        function loadLocalData() {
            const savedParticipants = localStorage.getItem('gestione_spese_participants');
            const savedExpenses = localStorage.getItem('gestione_spese_expenses');
            
            if (savedParticipants) {
                participants = JSON.parse(savedParticipants);
            }
            
            if (savedExpenses) {
                expenses = JSON.parse(savedExpenses);
            }
        }

        // === MODALITÀ CONDIVISA ===
        
        const API_BASE = '/api';
        
        function showCreateGroup() {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('createGroupForm').classList.remove('hidden');
        }

        function hideCreateGroup() {
            document.getElementById('sharedSelection').classList.remove('hidden');
            document.getElementById('createGroupForm').classList.add('hidden');
            document.getElementById('groupName').value = '';
            document.getElementById('groupDescription').value = '';
        }

        function showJoinGroup() {
            document.getElementById('sharedSelection').classList.add('hidden');
            document.getElementById('joinGroupForm').classList.remove('hidden');
        }

        function hideJoinGroup() {
            document.getElementById('sharedSelection').classList.remove('hidden');
            document.getElementById('joinGroupForm').classList.add('hidden');
            document.getElementById('joinGroupCode').value = '';
            document.getElementById('joinParticipantName').value = '';
        }

        async function createGroup() {
            const name = document.getElementById('groupName').value.trim();
            const description = document.getElementById('groupDescription').value.trim();
            
            if (!name) {
                showNotification('Inserisci il nome del gruppo', 'error');
                return;
            }
            
            try {
                showNotification('Creazione gruppo in corso...');
                
                const response = await fetch(`${API_BASE}/groups`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, description })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`Gruppo creato! Codice: ${data.code}`);
                    
                    // Carica l'interfaccia del gruppo
                    setTimeout(() => {
                        loadGroupInterface(data);
                    }, 1500);
                } else {
                    showNotification(data.error || 'Errore nella creazione del gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione. Verifica che il backend sia attivo.', 'error');
            }
        }

        async function joinGroup() {
            const code = document.getElementById('joinGroupCode').value.trim().toUpperCase();
            const participantName = document.getElementById('joinParticipantName').value.trim();
            
            if (!code || !participantName) {
                showNotification('Inserisci codice gruppo e nome', 'error');
                return;
            }
            
            try {
                showNotification('Connessione al gruppo...');
                
                // Prima ottieni le info del gruppo
                const groupResponse = await fetch(`${API_BASE}/groups/${code}`);
                const groupData = await groupResponse.json();
                
                if (!groupResponse.ok) {
                    showNotification(groupData.error || 'Gruppo non trovato', 'error');
                    return;
                }
                
                // Poi aggiungi il partecipante
                const participantResponse = await fetch(`${API_BASE}/groups/${code}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: participantName })
                });
                
                const participantData = await participantResponse.json();
                
                if (participantResponse.ok) {
                    showNotification('Unito al gruppo con successo!');
                    
                    // Ricarica i dati del gruppo aggiornati
                    const updatedGroupResponse = await fetch(`${API_BASE}/groups/${code}`);
                    const updatedGroupData = await updatedGroupResponse.json();
                    
                    setTimeout(() => {
                        loadGroupInterface(updatedGroupData);
                    }, 1000);
                } else {
                    showNotification(participantData.error || 'Errore nell\'unirsi al gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione. Verifica che il backend sia attivo.', 'error');
            }
        }

        function loadGroupInterface(group) {
            currentGroup = group;
            
            document.getElementById('createGroupForm').classList.add('hidden');
            document.getElementById('joinGroupForm').classList.add('hidden');
            document.getElementById('sharedSelection').classList.add('hidden');
            
            const totalAmount = group.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            
            const management = document.getElementById('groupManagement');
            management.innerHTML = `
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">${group.name}</h3>
                            <p class="text-gray-600">${group.description || 'Nessuna descrizione'}</p>
                        </div>
                        <div class="text-right">
                            <div class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium cursor-pointer" onclick="copyGroupCode()">
                                <i class="fas fa-copy mr-1"></i>${group.code}
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Clicca per copiare</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mb-4">
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600">${group.participants.length}</div>
                            <div class="text-sm text-blue-800">Partecipanti</div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-green-600">${group.expenses.length}</div>
                            <div class="text-sm text-green-800">Spese</div>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600">€${totalAmount.toFixed(2)}</div>
                            <div class="text-sm text-purple-800">Totale</div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="showAddParticipantForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-user-plus mr-2"></i>Aggiungi Partecipante
                        </button>
                        <button onclick="showAddExpenseForm()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors text-sm">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                        </button>
                        <button onclick="refreshGroup()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors text-sm">
                            <i class="fas fa-sync mr-2"></i>Aggiorna
                        </button>
                        <button onclick="showBalances()" class="bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm">
                            <i class="fas fa-balance-scale mr-2"></i>Bilanci
                        </button>
                    </div>
                </div>
                
                <!-- Form Aggiungi Partecipante -->
                <div id="addParticipantForm" class="hidden glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-user-plus text-blue-600 mr-2"></i>Aggiungi Partecipante
                    </h4>
                    <div class="flex gap-2">
                        <input type="text" id="newParticipantName" placeholder="Nome partecipante" 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="addParticipantToGroup()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                            Aggiungi
                        </button>
                        <button onclick="hideAddParticipantForm()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Annulla
                        </button>
                    </div>
                </div>
                
                <!-- Form Aggiungi Spesa -->
                <div id="addExpenseForm" class="hidden glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-plus text-green-600 mr-2"></i>Aggiungi Spesa
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="newExpenseDescription" placeholder="Descrizione spesa" 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="number" id="newExpenseAmount" placeholder="Importo €" step="0.01"
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <input type="date" id="newExpenseDate" 
                               class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        <select id="newExpensePayer" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <option value="">Chi ha pagato?</option>
                        </select>
                    </div>
                    <div id="expenseParticipants" class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dividi tra:</label>
                        <div id="expenseParticipantsList" class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            <!-- Checkbox partecipanti -->
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="addExpenseToGroup()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Aggiungi Spesa
                        </button>
                        <button onclick="hideAddExpenseForm()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            Annulla
                        </button>
                    </div>
                </div>
                
                <!-- Lista Partecipanti -->
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-users text-blue-600 mr-2"></i>Partecipanti (${group.participants.length})
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                        ${group.participants.map(participant => `
                            <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                <span class="font-medium text-gray-800">${participant.name}</span>
                                <button onclick="removeParticipantFromGroup('${participant.name}')" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Lista Spese -->
                <div class="glass-card rounded-xl p-6 shadow-xl mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">
                        <i class="fas fa-receipt text-green-600 mr-2"></i>Spese (${group.expenses.length})
                    </h4>
                    <div class="space-y-3 max-h-60 overflow-y-auto">
                        ${group.expenses.length === 0 ? 
                            '<p class="text-gray-500 text-center py-4">Nessuna spesa registrata</p>' :
                            group.expenses.map(expense => `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h5 class="font-medium text-gray-800">${expense.description}</h5>
                                            <p class="text-sm text-gray-600">€${expense.amount.toFixed(2)} - ${expense.date}</p>
                                            <p class="text-sm text-gray-600">Pagato da: ${expense.payer}</p>
                                            <p class="text-sm text-gray-600">Diviso tra: ${expense.participants.join(', ')}</p>
                                            <p class="text-sm text-gray-600">€${(expense.amount / expense.participants.length).toFixed(2)} a persona</p>
                                        </div>
                                        <button onclick="removeExpenseFromGroup(${expense.id})" class="text-red-500 hover:text-red-700">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
                
                <!-- Bilanci -->
                <div id="groupBalances" class="hidden glass-card rounded-xl p-6 shadow-xl mb-6">
                    <!-- I bilanci verranno caricati qui -->
                </div>
                
                <div class="glass-card rounded-xl p-6 shadow-xl text-center">
                    <button onclick="leaveGroup()" class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors">
                        <i class="fas fa-sign-out-alt mr-2"></i>Esci dal Gruppo
                    </button>
                </div>
            `;
            
            management.classList.remove('hidden');
            
            // Imposta la data di oggi per le nuove spese
            const today = new Date().toISOString().split('T')[0];
            setTimeout(() => {
                const dateInput = document.getElementById('newExpenseDate');
                if (dateInput) dateInput.value = today;
            }, 100);
            
            showNotification('Gruppo caricato con successo!');
        }

        function showAddParticipantForm() {
            document.getElementById('addParticipantForm').classList.remove('hidden');
            document.getElementById('newParticipantName').focus();
        }

        function hideAddParticipantForm() {
            document.getElementById('addParticipantForm').classList.add('hidden');
            document.getElementById('newParticipantName').value = '';
        }

        function showAddExpenseForm() {
            // Popola il select dei pagatori
            const payerSelect = document.getElementById('newExpensePayer');
            payerSelect.innerHTML = '<option value="">Chi ha pagato?</option>';
            currentGroup.participants.forEach(participant => {
                const option = document.createElement('option');
                option.value = participant.name;
                option.textContent = participant.name;
                payerSelect.appendChild(option);
            });
            
            // Popola le checkbox dei partecipanti
            const participantsList = document.getElementById('expenseParticipantsList');
            participantsList.innerHTML = '';
            currentGroup.participants.forEach(participant => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="expense_participant_${participant.name}" value="${participant.name}" class="mr-2">
                    <label for="expense_participant_${participant.name}" class="text-sm text-gray-700">${participant.name}</label>
                `;
                participantsList.appendChild(div);
            });
            
            document.getElementById('addExpenseForm').classList.remove('hidden');
        }

        function hideAddExpenseForm() {
            document.getElementById('addExpenseForm').classList.add('hidden');
            // Reset form
            document.getElementById('newExpenseDescription').value = '';
            document.getElementById('newExpenseAmount').value = '';
            document.getElementById('newExpensePayer').value = '';
            currentGroup.participants.forEach(participant => {
                const checkbox = document.getElementById(`expense_participant_${participant.name}`);
                if (checkbox) checkbox.checked = false;
            });
        }

        async function addParticipantToGroup() {
            const name = document.getElementById('newParticipantName').value.trim();
            
            if (!name) {
                showNotification('Inserisci un nome valido', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Partecipante aggiunto!');
                    hideAddParticipantForm();
                    refreshGroup();
                } else {
                    showNotification(data.error || 'Errore nell\'aggiungere il partecipante', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function removeParticipantFromGroup(name) {
            if (!confirm(`Rimuovere ${name} dal gruppo? Verranno eliminate anche le sue spese.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}/participants/${encodeURIComponent(name)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Partecipante rimosso');
                    refreshGroup();
                } else {
                    showNotification(data.error || 'Errore nella rimozione del partecipante', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function addExpenseToGroup() {
            const description = document.getElementById('newExpenseDescription').value.trim();
            const amount = parseFloat(document.getElementById('newExpenseAmount').value);
            const date = document.getElementById('newExpenseDate').value;
            const payer = document.getElementById('newExpensePayer').value;
            
            if (!description || !amount || !date || !payer) {
                showNotification('Compila tutti i campi obbligatori', 'error');
                return;
            }
            
            const selectedParticipants = [];
            currentGroup.participants.forEach(participant => {
                const checkbox = document.getElementById(`expense_participant_${participant.name}`);
                if (checkbox && checkbox.checked) {
                    selectedParticipants.push(participant.name);
                }
            });
            
            if (selectedParticipants.length === 0) {
                showNotification('Seleziona almeno un partecipante', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}/expenses`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        description,
                        amount,
                        date,
                        payer,
                        participants: selectedParticipants
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Spesa aggiunta!');
                    hideAddExpenseForm();
                    refreshGroup();
                } else {
                    showNotification(data.error || 'Errore nell\'aggiungere la spesa', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function removeExpenseFromGroup(expenseId) {
            if (!confirm('Rimuovere questa spesa?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}/expenses/${expenseId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showNotification('Spesa rimossa');
                    refreshGroup();
                } else {
                    showNotification(data.error || 'Errore nella rimozione della spesa', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function refreshGroup() {
            if (!currentGroup) return;
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}`);
                const data = await response.json();
                
                if (response.ok) {
                    loadGroupInterface(data);
                } else {
                    showNotification(data.error || 'Errore nel ricaricare il gruppo', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        async function showBalances() {
            if (!currentGroup) return;
            
            try {
                const response = await fetch(`${API_BASE}/groups/${currentGroup.code}/balances`);
                const data = await response.json();
                
                if (response.ok) {
                    displayGroupBalances(data.balances, data.reimbursements);
                } else {
                    showNotification(data.error || 'Errore nel calcolare i bilanci', 'error');
                }
            } catch (error) {
                console.error('Errore:', error);
                showNotification('Errore di connessione', 'error');
            }
        }

        function displayGroupBalances(balances, reimbursements) {
            const balancesDiv = document.getElementById('groupBalances');
            
            let balancesHtml = `
                <h4 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-balance-scale text-orange-600 mr-2"></i>Bilanci del Gruppo
                </h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            `;
            
            Object.entries(balances).forEach(([participant, balance]) => {
                let balanceClass = 'text-gray-800';
                let balanceText = '€0.00';
                let statusIcon = 'fas fa-equals';
                
                if (balance > 0.01) {
                    balanceClass = 'text-green-600 font-medium';
                    balanceText = `+€${balance.toFixed(2)}`;
                    statusIcon = 'fas fa-arrow-up';
                } else if (balance < -0.01) {
                    balanceClass = 'text-red-600 font-medium';
                    balanceText = `€${balance.toFixed(2)}`;
                    statusIcon = 'fas fa-arrow-down';
                }
                
                balancesHtml += `
                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <span class="font-medium text-gray-800">${participant}</span>
                        <div class="flex items-center">
                            <i class="${statusIcon} ${balanceClass} mr-2"></i>
                            <span class="${balanceClass}">${balanceText}</span>
                        </div>
                    </div>
                `;
            });
            
            balancesHtml += '</div>';
            
            if (reimbursements.length > 0) {
                balancesHtml += `
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h5 class="font-medium text-blue-800 mb-3">
                            <i class="fas fa-exchange-alt mr-2"></i>Rimborsi suggeriti:
                        </h5>
                        <div class="space-y-2">
                `;
                
                reimbursements.forEach(reimb => {
                    balancesHtml += `
                        <div class="flex items-center justify-between bg-white p-3 rounded border-l-4 border-blue-500">
                            <span class="text-blue-700">
                                <strong>${reimb.from}</strong> deve dare <strong>€${reimb.amount.toFixed(2)}</strong> a <strong>${reimb.to}</strong>
                            </span>
                            <i class="fas fa-arrow-right text-blue-500"></i>
                        </div>
                    `;
                });
                
                balancesHtml += '</div></div>';
            }
            
            balancesHtml += `
                <div class="text-center mt-4">
                    <button onclick="hideBalances()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        <i class="fas fa-times mr-2"></i>Chiudi Bilanci
                    </button>
                </div>
            `;
            
            balancesDiv.innerHTML = balancesHtml;
            balancesDiv.classList.remove('hidden');
        }

        function hideBalances() {
            document.getElementById('groupBalances').classList.add('hidden');
        }

        function copyGroupCode() {
            if (currentGroup) {
                navigator.clipboard.writeText(currentGroup.code);
                showNotification('Codice gruppo copiato!');
            }
        }

        function leaveGroup() {
            if (confirm('Uscire dal gruppo?')) {
                currentGroup = null;
                document.getElementById('groupManagement').classList.add('hidden');
                document.getElementById('sharedSelection').classList.remove('hidden');
                showNotification('Sei uscito dal gruppo');
            }
        }

        // === UTILITÀ ===
        
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            
            if (type === 'error') {
                notification.querySelector('div').className = 'bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg';
            } else {
                notification.querySelector('div').className = 'bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
            }
            
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
